<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java中的动态代理 | Libra</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/my-blogs/favicon.ico">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/my-blogs/assets/css/0.styles.3a0a8603.css" as="style"><link rel="preload" href="/my-blogs/assets/js/app.5c4894fb.js" as="script"><link rel="preload" href="/my-blogs/assets/js/4.606f7210.js" as="script"><link rel="preload" href="/my-blogs/assets/js/27.8df72ef4.js" as="script"><link rel="prefetch" href="/my-blogs/assets/js/1.4322e831.js"><link rel="prefetch" href="/my-blogs/assets/js/10.634cb625.js"><link rel="prefetch" href="/my-blogs/assets/js/11.2c013118.js"><link rel="prefetch" href="/my-blogs/assets/js/12.080e8d1a.js"><link rel="prefetch" href="/my-blogs/assets/js/13.118293e9.js"><link rel="prefetch" href="/my-blogs/assets/js/14.d3260683.js"><link rel="prefetch" href="/my-blogs/assets/js/15.55b0a007.js"><link rel="prefetch" href="/my-blogs/assets/js/16.4a9f1cb7.js"><link rel="prefetch" href="/my-blogs/assets/js/17.dfff4d54.js"><link rel="prefetch" href="/my-blogs/assets/js/18.3e8f4678.js"><link rel="prefetch" href="/my-blogs/assets/js/19.1d948539.js"><link rel="prefetch" href="/my-blogs/assets/js/20.6d62cff2.js"><link rel="prefetch" href="/my-blogs/assets/js/21.4434bc82.js"><link rel="prefetch" href="/my-blogs/assets/js/22.3de3da7a.js"><link rel="prefetch" href="/my-blogs/assets/js/23.d948741d.js"><link rel="prefetch" href="/my-blogs/assets/js/24.d71fbd71.js"><link rel="prefetch" href="/my-blogs/assets/js/25.57b89c32.js"><link rel="prefetch" href="/my-blogs/assets/js/26.0aea96de.js"><link rel="prefetch" href="/my-blogs/assets/js/28.f78015f5.js"><link rel="prefetch" href="/my-blogs/assets/js/29.8b96436c.js"><link rel="prefetch" href="/my-blogs/assets/js/30.6273c2d3.js"><link rel="prefetch" href="/my-blogs/assets/js/31.9702e8df.js"><link rel="prefetch" href="/my-blogs/assets/js/32.486e7ab5.js"><link rel="prefetch" href="/my-blogs/assets/js/33.20ed0e93.js"><link rel="prefetch" href="/my-blogs/assets/js/34.ae856740.js"><link rel="prefetch" href="/my-blogs/assets/js/35.c84b19fb.js"><link rel="prefetch" href="/my-blogs/assets/js/36.b55d8194.js"><link rel="prefetch" href="/my-blogs/assets/js/37.c1964c49.js"><link rel="prefetch" href="/my-blogs/assets/js/38.a9505e40.js"><link rel="prefetch" href="/my-blogs/assets/js/39.1f6f667e.js"><link rel="prefetch" href="/my-blogs/assets/js/40.b7722cda.js"><link rel="prefetch" href="/my-blogs/assets/js/41.066296d2.js"><link rel="prefetch" href="/my-blogs/assets/js/5.77a1a8e9.js"><link rel="prefetch" href="/my-blogs/assets/js/6.1d9faf0f.js"><link rel="prefetch" href="/my-blogs/assets/js/7.b5f2ee69.js"><link rel="prefetch" href="/my-blogs/assets/js/8.9f4b05b2.js"><link rel="prefetch" href="/my-blogs/assets/js/9.ae8b7c55.js"><link rel="prefetch" href="/my-blogs/assets/js/vuejs-paginate.1d5dbcf0.js">
    <link rel="stylesheet" href="/my-blogs/assets/css/0.styles.3a0a8603.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="article"><nav class="topbar"><span class="logo"><span class="logo-text">L</span></span> <ul class="menu"><li class="menu-item"><a href="/my-blogs/" class="link router-link-active">主页</a></li> <li class="menu-item"><a href="/my-blogs/blog" class="link">博客</a></li> <li class="menu-item"><a href="/my-blogs/tag" class="link">标签</a></li> <li class="menu-item"><a href="/my-blogs/category" class="link">分类</a></li> <li class="menu-item"><a href="/my-blogs/timeline" class="link">时间线</a></li> <li class="menu-item"><a href="/my-blogs/contact" class="link">联系我</a></li></ul> <div class="search"><i class="iconfont iconsearch"></i> <div class="search-box" data-v-085dd956><input aria-label="Search" placeholder="请输入你想要搜索的内容..." autocomplete="off" spellcheck="false" value="" data-v-085dd956> <!----></div></div> <span class="mobile-nav"><i class="iconfont iconnav"></i></span> <nav class="mobile-nav-item" style="display:none;"><div class="header-button"><i class="iconfont iconback"></i></div> <div class="header-info"><div class="avatar"><img src="https://lunatics.oss-cn-hangzhou.aliyuncs.com/icon.jpg" alt="" class="avatar-img"></div> <span class="name">CheesyCrab</span> <i class="mail">1592913644@qq.com</i> <div class="statistics"><span class="articles">
            26
            <i class="white"> 文章</i></span> <span class="verticle-line white">|</span> <span class="link">
            13
            <i class="white"> 分类</i></span></div></div> <div class="line"></div> <ul class="nav-menu"><li class="nav-menu-item"><a href="/my-blogs/" class="router-link-active"><i class="iconfont iconhome"></i> <i class="white">主页</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/blog"><i class="iconfont iconblog"></i> <i class="white">博客</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/tag"><i class="iconfont iconlabel"></i> <i class="white">标签</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/category"><i class="iconfont iconfenlei-"></i> <i class="white">分类</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/timeline"><i class="iconfont icontimeline"></i> <i class="white">时间线</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/contact"><i class="iconfont iconother"></i> <i class="white">联系我</i></a></li></ul></nav></nav> <div id="particles-js" color="#fff" particleOpacity="0.7" linesColor="#fff" particlesNumber="60" shapeType="circle" particleSize="4" linesWidth="1" lineLinked="true" lineOpacity="0.4" linesDistance="150" moveSpeed="6" hoverEffect="true" hoverMode="grab" clickEffect="true" clickMode="push" class="bg"></div> <div class="article-content"><div class="left"><span class="title animated rollIn">Java中的动态代理</span> <ul class="label animated zoomInUp"><li class="date"><i class="iconfont iconshizhong"></i>
          2022-9-12
        </li> <li class="update"><i class="iconfont iconUpdate"></i>
          2022-9-12
        </li> <li class="labels"><i class="iconfont iconlabel"></i>
          Java
        </li></ul> <div class="image"><img src="https://lunatics.oss-cn-hangzhou.aliyuncs.com/blog/tecTop.jpg" alt width="100%"></div> <div class="detail"><div><div class="content__default"><p><strong>本文参考</strong>：[CSDN] ready? go!：<strong>Java两种动态代理JDK动态代理和CGLIB动态代理</strong>，<a href="https://blog.csdn.net/flyfeifei66/article/details/81481222" target="_blank" rel="noopener noreferrer">原文链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>其实就是对本文的学习和复述。</p> <h2 id="代理模式"><a href="#代理模式" class="header-anchor">#</a> 代理模式</h2> <p>​	代理模式是23种设计模式的一种，指的是一个对象A通过持有另一个对象B，可以具有B同样的行为的模式。为了对外开放协议，B往往实现了一个接口，（为了有与B同样的行为）A当然也会去实现这个接口，但是B是这个接口的“真正”的实现类，而A则比较“虚”，它只是借用B去实现接口。在这种情况下，A可以去为B的方法做增强，在调用B方法的前后都做一些其他的事情。Spring中的 AOP就是使用了动态代理完成了代码的“切面”。</p> <h2 id="jdk动态代理"><a href="#jdk动态代理" class="header-anchor">#</a> JDK动态代理</h2> <p>JDK动态代理是JRE提供的类库，可以直接使用而不依赖第三方，下面举出一个例子。</p> <p>首先有个“明星”接口类，接口有唱、跳两个功能：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Star</span> <span class="token punctuation">{</span>
<span class="token class-name">String</span> <span class="token function">sing</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> <span class="token function">dance</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着创建一个LiuDeHua类来实现Star接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span></span><span class="token class-name">Star</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LiuDeHua</span> <span class="token keyword">implements</span> <span class="token class-name">Star</span> <span class="token punctuation">{</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sing</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;唱歌&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;唱完&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">dance</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;跳舞&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;跳完&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>在刘德华演出前需要有人准备一些其他服务（如收钱，售票之类的），自己不做这个工作，一般交给经纪人来处理，为了便于理解，它的名字用Proxy结尾，但实际上它不是代理类，因为没有实现Star接口，无法对外提供服务，它只是一个wrapeper</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span>proxy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StarProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
<span class="token comment">//提供一个目标类，即被代理的对象</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> target<span class="token punctuation">;</span>
<span class="token comment">//输入被包装对象</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTarget</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">//收钱就是方法的增强</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收钱&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里是原方法的执行</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token class-name">CreateProxyedObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>​	上述例子中，CreateProxyedObj方法返回的对象才是我们的代理类，它需要三个参数，前两个参数的意思是在同一个classloader下通过接口创建出一个对象，第三个参数属性是一个InvocationHandler。**这个CreateProxyedObj方法不一定要在StarProxy类中，通常可以放在一个工厂类中。**上述代理的代码过程如下：</p> <div class="language- extra-class"><pre><code>   1. new一个目标对象
   2. new一个InvocationHandler，将对象注入进去
   3. 通过CreateProxyedObj创建代理对象，强转为目标对象的接口类型即可使用，实际上生成的代理对象实现了目标接口（例子中的Star接口）
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">LiuDeHua</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span><span class="token class-name">StarProxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> testProxy <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//获得被代理的对象</span>
       <span class="token class-name">LiuDeHua</span> liuDeHua <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LiuDeHua</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       liuDeHua<span class="token punctuation">.</span><span class="token function">sing</span><span class="token punctuation">(</span><span class="token string">&quot;刘德华&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       liuDeHua<span class="token punctuation">.</span><span class="token function">dance</span><span class="token punctuation">(</span><span class="token string">&quot;刘德华&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//获得代理的 InvocationHandler</span>
       <span class="token comment">//InvocationHandler中可以对被代理对象的方法进行增强</span>
       <span class="token class-name">StarProxy</span> starProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StarProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//将被代理对象注入starProxy</span>
       starProxy<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>liuDeHua<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//从被代理的对象中得到动态代理对象，使用强转</span>
       <span class="token class-name">Star</span> liuDeHuaProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Star</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token namespace">starProxy<span class="token punctuation">.</span></span>CreateProxyedObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       liuDeHuaProxy<span class="token punctuation">.</span><span class="token function">sing</span><span class="token punctuation">(</span><span class="token string">&quot;proxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;===============&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       liuDeHuaProxy<span class="token punctuation">.</span><span class="token function">dance</span><span class="token punctuation">(</span><span class="token string">&quot;proxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token comment">//增强是对接口的所有方法都增强，（？）所以要尽可能面向接口使用代理</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Proxy（JDK类库提供）根据B的接口生成一个实现类C，C就是动态代理类。C的生成过程是：由于知道了接口，就可以知道接口中的所有信息（主要是方法的定义），就可以去声明一个实现所有接口方法的新类型，这些方法都是“虚”的，只是调用了另一个对象的方法。<strong>这个被调用的对象不能是对象B，如果是对象B，就无法对其方法进行增强</strong>，所以它调用了B的包装类，这个包装类需要我们实现，但是JDK要求这个包装类必须实现InvocationHandler（StarProxy），这个接口的invoke方法是所有target（原始类，即B）方法的调用入口，调用之前我们可以加上自己的代码进行增强。</p> <p>所以可以认为C代理了InvocationHandler，InvocationHandler代理了B，两级代理。动态代理需要生成一个包装类对象，代理的对象是动态的。由于我们需要对原对象方法进行增强，代理类不能直接包含原对象，而是一个InvocationHandler，这个InvocationHandler包含原对象，并负责分发请求给原对象，分发前后均可以做增强，可以看出，JDK代理是“<strong>对象</strong>”的代理。</p> <p>Proxy创造的是自己（Proxy）的子类，并且实现了B的接口</p> <p><img src="https://lunatics.oss-cn-hangzhou.aliyuncs.com/blog/jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86.jpg" alt="JDK动态代理"></p> <h2 id="cglib动态代理"><a href="#cglib动态代理" class="header-anchor">#</a> CGLIB动态代理</h2> <p>我们了解到，代理的目的是构造一个和被代理的对有同样行为的对象，一个对象的行为是在类中定义的，对象只能是类的实例。所以构造代理不一定非得通过持有、包装对象这一种方式。</p> <p>通过继承可以继承父类的所有的公开方法，然后可以重写这些方法，然后在重写时对这些方法进行增强，这就是CGLIB的思想。根据里氏代换原则，父类需要出现的地方，子类可以出现，所以cglib实现的代理也是可以被正常使用的</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span>proxy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span><span class="token class-name">Enhancer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span><span class="token class-name">MethodInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span><span class="token class-name">MethodProxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CglibProxy</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>
   <span class="token comment">//根据一个类型产生代理类，此方法不一定要放在MethodInterceptor中</span>
   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token class-name">CreateProxyedObj</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token operator">&lt;</span><span class="token operator">?</span> clazz<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
       enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token comment">//返回的结果正是我们需要的代理类</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收钱&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Object</span> res <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这是原方法</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> res<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从代码看出，它与JDK动态代理有所不同，对外表现看CreatProxyedObj，它只需要一个类型的clazz就可以产生一个代理对象，所以说是”<strong>类的代理</strong>“，而且创造的对象通过打印类型发现也是新的类型。不同于JDK动态代理，JDK动态代理要求对象必须实现接口（三个参数的第二个参数），cglib对此没有要求</p> <p>cglib生成一个继承B的类型C（代理类），这个代理类持有一个我们setCallback传入的MethodInterceptor，构造名叫“<code>CGLIB</code>”+“<code>$父类方法名$</code>”的方法,方法体里只有一句super.父类方法名()，可以简单地认为保持了对父类方法的一个引用，方便调用。（<strong>下文用cglib方法指代</strong>）</p> <p>这样的话，C中就有了重写方法，cglib方法，父类方法（不可见），还有一个同一的拦截方法（增强方法intercept）。其中重写方法和cglib方法存在映射关系。C的重写方法是外界调用的入口，它调用intercept方法，调用时会传递四个参数，<strong>第一个参数传递的是this，代表代理类本身，第二个参数代表拦截的方法，第三个参数是入参，第四个参数是cglib方法，intercept方法完成增强后，我们调用cglib方法间接调用父类方法完成整个方法链的调用</strong></p> <p>为什么是使用methodProxy调用的方法而不是使用method调用，这里原类型已经作为父类被子类继承，父类的方法被子类隐藏，如果使用method调用之后调用子类的方法，显然会陷入循环。</p> <p>同时，methodProxy调用的是invokeSuper方法，这是因为cglib采用了fastclass机制，不仅巧妙地避开了调不到父类方法的问题，还加速了方法的调用。</p> <p>fastclass：给每个方法编号，通过编号找到犯法执行避免通过反射调用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">LiuDeHua</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>cehire<span class="token punctuation">.</span>myProxy<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span><span class="token class-name">CglibProxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> testProxy <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">CglibProxy</span> cglibProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Star</span> obj <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">Star</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">cglibProxy<span class="token punctuation">.</span></span>CreateProxyedObj</span><span class="token punctuation">(</span><span class="token class-name">LiuDeHua</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       obj<span class="token punctuation">.</span><span class="token function">dance</span><span class="token punctuation">(</span><span class="token string">&quot;刘德华&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       obj<span class="token punctuation">.</span><span class="token function">sing</span><span class="token punctuation">(</span><span class="token string">&quot;刘德华&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="二者区别"><a href="#二者区别" class="header-anchor">#</a> 二者区别</h2> <p>相较于JDK动态代理，cglib依然需要一个第三者分发请求，只不过JDK动态代理分发给了目标对象，cglib最终分发给自己（继承B的C），通过给method编号完成调用。经测试，JDK创建对象的速度远大于cglib，这是由于cglib创建对象时需要操作字节码，cglib执行速度略大于jdk，所以比较适合单例模式。另外由于cglib的大部分类是直接对Java字节码进行操作，这样生成的类会在Java的永久堆中。如果动态代理操作过多，容易造成永久堆满，触发OOM异常，spring默认使用的是JDK动态代理，如果类没有接口，则使用cglib代理。</p></div></div></div> <!----></div> <div class="right"><div class="test animated bounceInRight" data-v-1daa5799><span class="labeltitle" data-v-1daa5799>分类</span> <div class="label-container" data-v-1daa5799><a href="/my-blogs/category" class="container" data-v-3fd29ed0 data-v-1daa5799>
  All
</a><a href="/my-blogs/category/blender" class="container" data-v-3fd29ed0 data-v-1daa5799>
  blender
</a><a href="/my-blogs/category/Java" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Java
</a><a href="/my-blogs/category/Mysql" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Mysql
</a><a href="/my-blogs/category/spring" class="container" data-v-3fd29ed0 data-v-1daa5799>
  spring
</a><a href="/my-blogs/category/Rust" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Rust
</a><a href="/my-blogs/category/java" class="container" data-v-3fd29ed0 data-v-1daa5799>
  java
</a><a href="/my-blogs/category/计算机网络" class="container" data-v-3fd29ed0 data-v-1daa5799>
  计算机网络
</a><a href="/my-blogs/category/Java多线程" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Java多线程
</a><a href="/my-blogs/category/C#" class="container" data-v-3fd29ed0 data-v-1daa5799>
  C#
</a><a href="/my-blogs/category/Python" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Python
</a><a href="/my-blogs/category/C++" class="container" data-v-3fd29ed0 data-v-1daa5799>
  C++
</a><a href="/my-blogs/category/计算机图形学" class="container" data-v-3fd29ed0 data-v-1daa5799>
  计算机图形学
</a><a href="/my-blogs/category/数学基础" class="container" data-v-3fd29ed0 data-v-1daa5799>
  数学基础
</a></div></div> <div class="my" data-v-85113e2e><div class="header-info" data-v-85113e2e><div class="avatar" data-v-85113e2e><img src="https://lunatics.oss-cn-hangzhou.aliyuncs.com/icon.jpg" alt class="avatar-img" data-v-85113e2e></div> <span class="name" data-v-85113e2e>CheesyCrab</span> <i class="mail" data-v-85113e2e>1592913644@qq.com</i> <div class="statistics" data-v-85113e2e><span class="articles" data-v-85113e2e>
        26
        <i class="white" data-v-85113e2e> 文章</i></span> <span class="verticle-line white" data-v-85113e2e>|</span> <span class="link" data-v-85113e2e>
        13
        <i class="white" data-v-85113e2e> 分类</i></span></div> <a href="/my-blogs/contact" class="more" data-v-85113e2e>联系我</a></div></div> <div class="list"><div><ul><li><a href="/my-blogs/2022/09/12/no1%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#代理模式">代理模式</a></li><li><a href="/my-blogs/2022/09/12/no1%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#jdk动态代理">JDK动态代理</a></li><li><a href="/my-blogs/2022/09/12/no1%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#cglib动态代理">CGLIB动态代理</a></li><li><a href="/my-blogs/2022/09/12/no1%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#二者区别">二者区别</a></li></ul></div></div></div></div> <div class="footer"><div class="left"><div class="wave-libra"><div class="wavetext"><div class="coast delay"><div class="wave-rel-wrap"><div class="wave delay"></div></div></div> <div class="text text-l">L</div> <div class="text text-i">i</div> <div class="text text-b">b</div> <div class="text text-r">r</div> <div class="text text-a">a</div></div></div></div> <div class="right">
    Copyright © 2019-2020 Libra | 版权所有
  </div></div></div><div class="global-ui"><!----></div></div>
    <script src="/my-blogs/assets/js/app.5c4894fb.js" defer></script><script src="/my-blogs/assets/js/4.606f7210.js" defer></script><script src="/my-blogs/assets/js/27.8df72ef4.js" defer></script>
  </body>
</html>
