<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mysql中的索引 | Libra</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/my-blogs/favicon.ico">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/my-blogs/assets/css/0.styles.3a0a8603.css" as="style"><link rel="preload" href="/my-blogs/assets/js/app.5c4894fb.js" as="script"><link rel="preload" href="/my-blogs/assets/js/4.606f7210.js" as="script"><link rel="preload" href="/my-blogs/assets/js/20.6d62cff2.js" as="script"><link rel="prefetch" href="/my-blogs/assets/js/1.4322e831.js"><link rel="prefetch" href="/my-blogs/assets/js/10.634cb625.js"><link rel="prefetch" href="/my-blogs/assets/js/11.2c013118.js"><link rel="prefetch" href="/my-blogs/assets/js/12.080e8d1a.js"><link rel="prefetch" href="/my-blogs/assets/js/13.118293e9.js"><link rel="prefetch" href="/my-blogs/assets/js/14.d3260683.js"><link rel="prefetch" href="/my-blogs/assets/js/15.55b0a007.js"><link rel="prefetch" href="/my-blogs/assets/js/16.4a9f1cb7.js"><link rel="prefetch" href="/my-blogs/assets/js/17.dfff4d54.js"><link rel="prefetch" href="/my-blogs/assets/js/18.3e8f4678.js"><link rel="prefetch" href="/my-blogs/assets/js/19.1d948539.js"><link rel="prefetch" href="/my-blogs/assets/js/21.4434bc82.js"><link rel="prefetch" href="/my-blogs/assets/js/22.3de3da7a.js"><link rel="prefetch" href="/my-blogs/assets/js/23.d948741d.js"><link rel="prefetch" href="/my-blogs/assets/js/24.d71fbd71.js"><link rel="prefetch" href="/my-blogs/assets/js/25.57b89c32.js"><link rel="prefetch" href="/my-blogs/assets/js/26.0aea96de.js"><link rel="prefetch" href="/my-blogs/assets/js/27.8df72ef4.js"><link rel="prefetch" href="/my-blogs/assets/js/28.f78015f5.js"><link rel="prefetch" href="/my-blogs/assets/js/29.8b96436c.js"><link rel="prefetch" href="/my-blogs/assets/js/30.6273c2d3.js"><link rel="prefetch" href="/my-blogs/assets/js/31.9702e8df.js"><link rel="prefetch" href="/my-blogs/assets/js/32.486e7ab5.js"><link rel="prefetch" href="/my-blogs/assets/js/33.20ed0e93.js"><link rel="prefetch" href="/my-blogs/assets/js/34.ae856740.js"><link rel="prefetch" href="/my-blogs/assets/js/35.c84b19fb.js"><link rel="prefetch" href="/my-blogs/assets/js/36.b55d8194.js"><link rel="prefetch" href="/my-blogs/assets/js/37.c1964c49.js"><link rel="prefetch" href="/my-blogs/assets/js/38.a9505e40.js"><link rel="prefetch" href="/my-blogs/assets/js/39.1f6f667e.js"><link rel="prefetch" href="/my-blogs/assets/js/40.b7722cda.js"><link rel="prefetch" href="/my-blogs/assets/js/41.066296d2.js"><link rel="prefetch" href="/my-blogs/assets/js/5.77a1a8e9.js"><link rel="prefetch" href="/my-blogs/assets/js/6.1d9faf0f.js"><link rel="prefetch" href="/my-blogs/assets/js/7.b5f2ee69.js"><link rel="prefetch" href="/my-blogs/assets/js/8.9f4b05b2.js"><link rel="prefetch" href="/my-blogs/assets/js/9.ae8b7c55.js"><link rel="prefetch" href="/my-blogs/assets/js/vuejs-paginate.1d5dbcf0.js">
    <link rel="stylesheet" href="/my-blogs/assets/css/0.styles.3a0a8603.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="article"><nav class="topbar"><span class="logo"><span class="logo-text">L</span></span> <ul class="menu"><li class="menu-item"><a href="/my-blogs/" class="link router-link-active">主页</a></li> <li class="menu-item"><a href="/my-blogs/blog" class="link">博客</a></li> <li class="menu-item"><a href="/my-blogs/tag" class="link">标签</a></li> <li class="menu-item"><a href="/my-blogs/category" class="link">分类</a></li> <li class="menu-item"><a href="/my-blogs/timeline" class="link">时间线</a></li> <li class="menu-item"><a href="/my-blogs/contact" class="link">联系我</a></li></ul> <div class="search"><i class="iconfont iconsearch"></i> <div class="search-box" data-v-085dd956><input aria-label="Search" placeholder="请输入你想要搜索的内容..." autocomplete="off" spellcheck="false" value="" data-v-085dd956> <!----></div></div> <span class="mobile-nav"><i class="iconfont iconnav"></i></span> <nav class="mobile-nav-item" style="display:none;"><div class="header-button"><i class="iconfont iconback"></i></div> <div class="header-info"><div class="avatar"><img src="https://lunatics.oss-cn-hangzhou.aliyuncs.com/icon.jpg" alt="" class="avatar-img"></div> <span class="name">CheesyCrab</span> <i class="mail">1592913644@qq.com</i> <div class="statistics"><span class="articles">
            26
            <i class="white"> 文章</i></span> <span class="verticle-line white">|</span> <span class="link">
            13
            <i class="white"> 分类</i></span></div></div> <div class="line"></div> <ul class="nav-menu"><li class="nav-menu-item"><a href="/my-blogs/" class="router-link-active"><i class="iconfont iconhome"></i> <i class="white">主页</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/blog"><i class="iconfont iconblog"></i> <i class="white">博客</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/tag"><i class="iconfont iconlabel"></i> <i class="white">标签</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/category"><i class="iconfont iconfenlei-"></i> <i class="white">分类</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/timeline"><i class="iconfont icontimeline"></i> <i class="white">时间线</i></a></li> <li class="nav-menu-item"><a href="/my-blogs/contact"><i class="iconfont iconother"></i> <i class="white">联系我</i></a></li></ul></nav></nav> <div id="particles-js" color="#fff" particleOpacity="0.7" linesColor="#fff" particlesNumber="60" shapeType="circle" particleSize="4" linesWidth="1" lineLinked="true" lineOpacity="0.4" linesDistance="150" moveSpeed="6" hoverEffect="true" hoverMode="grab" clickEffect="true" clickMode="push" class="bg"></div> <div class="article-content"><div class="left"><span class="title animated rollIn">Mysql中的索引</span> <ul class="label animated zoomInUp"><li class="date"><i class="iconfont iconshizhong"></i>
          2022-9-21
        </li> <li class="update"><i class="iconfont iconUpdate"></i>
          2022-9-21
        </li> <li class="labels"><i class="iconfont iconlabel"></i>
          Mysql
        </li></ul> <div class="image"><img src="https://lunatics.oss-cn-hangzhou.aliyuncs.com/blog/tecTop.jpg" alt width="100%"></div> <div class="detail"><div><div class="content__default"><h2 id="索引概述"><a href="#索引概述" class="header-anchor">#</a> 索引概述</h2> <p><strong>索引是帮助MySQL高效获取数据的数据结构（有序）</strong>。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用数据，这样就可以在这些数据库上实现高级查找算法。</p> <p>无索引的情况下会进行全表扫描，效率很低</p> <ul><li>优点：提高数据检索效率，降低数据库的IO成本；通过索引对数据进行排序，降低数据排序的成本，降低CPU的消耗</li> <li>缺点：索引列占用空间；提高查询效率，同时也降低更新表的速度，对表进行增删改的时候效率较低</li></ul> <h2 id="索引结构"><a href="#索引结构" class="header-anchor">#</a> 索引结构</h2> <p>MySQL的索引是在存储引擎层实现的，不同的存储引擎有不同的结构</p> <table><thead><tr><th style="text-align:center;">索引结构</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">B+Tree索引</td> <td style="text-align:center;">最常见的索引类型，大部分引擎都支持B+Tree索引</td></tr> <tr><td style="text-align:center;">Hash索引</td> <td style="text-align:center;">底层数据结构是用哈希表实现的，只有精确匹配索引列的查询才有效，不支持范围查询</td></tr> <tr><td style="text-align:center;">R-tree（空间索引）</td> <td style="text-align:center;">空间索引是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少</td></tr> <tr><td style="text-align:center;">Full-text（全文索引）</td> <td style="text-align:center;">是一种通过建立倒排索引，快速匹配文档的方式，类似于ES</td></tr></tbody></table> <table><thead><tr><th style="text-align:center;">索引</th> <th style="text-align:center;">InnoDB</th> <th style="text-align:center;">MyISAM</th> <th style="text-align:center;">Memory</th></tr></thead> <tbody><tr><td style="text-align:center;">B+tree</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">支持</td></tr> <tr><td style="text-align:center;">Hash</td> <td style="text-align:center;">-</td> <td style="text-align:center;">-</td> <td style="text-align:center;">支持</td></tr> <tr><td style="text-align:center;">R-tree</td> <td style="text-align:center;">-</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">-</td></tr> <tr><td style="text-align:center;">Full-text</td> <td style="text-align:center;">5.6后支持</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">-</td></tr></tbody></table> <p>==我们平常说的索引，如果没有特别指明，都是指B+树结构组织的索引==</p> <hr> <h3 id="b-tree-多路平衡查找树"><a href="#b-tree-多路平衡查找树" class="header-anchor">#</a> B-Tree（多路平衡查找树）</h3> <h3 id="hash索引"><a href="#hash索引" class="header-anchor">#</a> Hash索引</h3> <p>特点：</p> <ul><li>Hash索引只能用于对等比较，不支持范围查询</li> <li>无法利用索引完成排序操作</li> <li>查询效率高</li></ul> <p>存储引擎支持：在MySQL中，支持hash索引的是memory引擎，而InnoDB中具有自适应hash功能，hash索引是存储引擎根据B+tree索引在指定条件下自动构建的</p> <p>==InnoDB为什么使用B+Tree索引==</p> <hr> <table><thead><tr><th style="text-align:center;">分类</th> <th style="text-align:center;">含义</th> <th style="text-align:center;">特点</th> <th style="text-align:center;">关键字</th></tr></thead> <tbody><tr><td style="text-align:center;">主键索引</td> <td style="text-align:center;">针对于表中主键创建的索引</td> <td style="text-align:center;">默认自动创建，只能有一个</td> <td style="text-align:center;">PRIMARY</td></tr> <tr><td style="text-align:center;">唯一索引</td> <td style="text-align:center;">避免同一个表中数据列中值的重复</td> <td style="text-align:center;">可以有多个</td> <td style="text-align:center;">UNIQUE</td></tr> <tr><td style="text-align:center;">常规索引</td> <td style="text-align:center;">快速定位特定</td> <td style="text-align:center;">可以有多个</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">全文索引</td> <td style="text-align:center;">全文索引查找的是文本中的关键词，而不是比较索引中的值</td> <td style="text-align:center;">可以有多个</td> <td style="text-align:center;">FULLTEXT</td></tr></tbody></table> <hr> <p>在InnoDB存储引擎中，根据索引的存储形式，又可以分为聚集索引和二级索引</p> <table><thead><tr><th style="text-align:center;">分类</th> <th style="text-align:center;">含义</th> <th style="text-align:center;">特点</th></tr></thead> <tbody><tr><td style="text-align:center;">聚集索引</td> <td style="text-align:center;">将数据存储与索引放到了一块，索引结构的叶子节点保存了行数据</td> <td style="text-align:center;">必须有且只有一个</td></tr> <tr><td style="text-align:center;">二级索引</td> <td style="text-align:center;">将数据与索引分开存储，索引结构的叶子节点关联的是对应的主键</td> <td style="text-align:center;">可以存在多个</td></tr></tbody></table> <p>聚集索引选取规则：</p> <ul><li>如果存在主键，主键索引就是聚集索引</li> <li>如果不存在主键，将使用第一个唯一索引作为聚集索引</li> <li>如果以上都没有则会自动生成一个rowid作为隐藏的聚集索引</li></ul> <h2 id="索引语法"><a href="#索引语法" class="header-anchor">#</a> 索引语法</h2> <ul><li>创建索引：<code>create [unique|fulltext] index index_name on table_name(index_col_name,...)</code></li> <li>查看索引：<code>show index from table_name</code></li> <li>删除索引：<code>drop index index_name on table_name</code></li></ul> <div class="language-mysql extra-class"><pre class="language-text"><code># 为name字段创建索引，name可能重复
create index idx_user_name on tb_user(name);
# 为phone创建唯一索引
create unique index idx_user_phone on tb_user(phone);
# 为profession、age、status创建联合索引
create idx_user_pro_age_sta on tb_user(profession,age,status);
# 为email建立合适的索引来提升查询效率
create fulltext index idx_user_email on tb_user(email);
# 查看索引
show index from tb_user;
# 删除name表的索引
drop index idx_user_name on tb_user;
</code></pre></div><h2 id="sql性能分析"><a href="#sql性能分析" class="header-anchor">#</a> SQL性能分析</h2> <p>MySQL客户端连接成功后，通过<code>show [session|global] status命令可以提供服务器状态信息。</code></p> <ul><li>insert、update、delete、select的访问频次：<code>show global status like 'Com_______'(7个下划线)</code></li></ul> <h3 id="慢查询日志"><a href="#慢查询日志" class="header-anchor">#</a> 慢查询日志</h3> <p>慢查询日志记录了所有执行时间超过指定参数（long_query_time，单位秒，默认10秒，可以通过<code>show variables like 'slow_query_log'</code>查询），的所有的SQL语句的日志。MySQL的慢查询日志默认没有开启，需要在MySQL的配置文件（/etc/my.cnf）中配置如下信息：</p> <div class="language-mysql extra-class"><pre class="language-text"><code># 开启慢查询开关
slow_query_log=1
#设置慢日志的时间为2秒
long_query_time=2
</code></pre></div><p>配置完毕后，重启MySQL服务器，慢日志会记录在/var/lib/mysql/localhost-slow.log</p> <h3 id="profile详情"><a href="#profile详情" class="header-anchor">#</a> profile详情</h3> <p>通过have_profiling参数，能够看到当前MySQL是否支持profile操作：<code>select @@have_profiling</code></p> <p>默认profiling是关闭的，可以通过set语句在session或global级别开启profiling：<code>set [session|global] profiling = 1</code></p> <div class="language-mysql extra-class"><pre class="language-text"><code>#查看每一条SQL的耗时基本情况
show profiles;
#查看指定query_id的SQL语句各个阶段的耗时情况
show profile for query query_id;
#查看指定query_id的CPU的使用情况
show profile cup for query query_id;
</code></pre></div><h3 id="explain执行计划"><a href="#explain执行计划" class="header-anchor">#</a> ==explain执行计划==</h3> <p>explain或者desc命令获取MySQL如何执行select语句的信息，包括在select语句执行过程中表如何连接和连接的顺序。：<code>explain/desc select 字段列表 from 表名 where 条件</code></p> <p>各字段含义：</p> <ul><li>id：select查询的序列号，表示查询中执行力select子句或者是操作表的顺序（id相同，执行顺序从上到下；id值不同，值越大越优先执行）</li> <li>select_type：表示select的类型，常见的取值有simple（简答表，即不适用表连接或者子查询）、primary（主查询，即外层的查询）、union（union中的第二个或者后面的查询语句）、subquery（select/where之后包含了子查询）等</li> <li>type：表示连接类型，性能由好到差的连接类型为null，system，const，eq_ref、ref、range、index、all</li> <li>possible_key：显示可能应用在这张表上的索引，一个或多个</li> <li>key：实际使用的索引</li> <li>key_len：索引中使用的字节数，改值为索引字段最大可能长度，并非使用长度</li> <li>rows：执行查询的长度（预估）</li> <li>filtered：返回结果的行数占需要读取的行数的百分比</li> <li>extra：额外信息</li></ul> <h2 id="索引使用"><a href="#索引使用" class="header-anchor">#</a> 索引使用</h2> <ul><li><p>最左前缀法则：如果索引了多列（联合索引），要遵守最左前缀法则，最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列，如果跳跃某一列，<strong>索引将部分失效（后面的字段索引失效）</strong></p></li> <li><p>联合索引中，出现范围查询，范围查询<strong>右侧</strong>的索引列失效，<strong>在业务允许的范围内使用大于等于或者小于等于的范围查询</strong></p></li> <li><p>不要在索引列上进行运算操作，否则索引失效</p></li> <li><p>字符串类型使用时，不加引号，索引将失效（隐式类型转换导致），==所以一定要加引号==</p></li> <li><p>如果使用头部模糊匹配，索引将失效；如果仅是尾部模糊匹配，索引不会失效（因为B+树是排序树）</p></li> <li><p>用or分割开的条件，如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及到的索引都不会被用到</p></li> <li><p>如果MySQL评估使用索引比全表更慢，则不使用索引</p></li></ul> <h3 id="sql提示"><a href="#sql提示" class="header-anchor">#</a> SQL提示</h3> <p>在from后加入提示使MySQL按照我们指定的索引查找</p> <ul><li>use index（建议）</li> <li>ignore index</li> <li>force index（强制）</li></ul> <h3 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h3> <p>覆盖索引指的是查询中使用了索引，并且需要返回的列在该索引中已经全部能够找到。<strong>尽量使用</strong>覆盖索引，减少select *</p> <p>extra列的信息：</p> <ul><li>using index condition：查找使用了索引，但是需要回表查询数据</li> <li>using where；using index：查找使用了索引，但是需要的数据都在索引列中能找到，索引不需要回表查询数据（索引列包含查询列）</li></ul> <h3 id="前缀索引"><a href="#前缀索引" class="header-anchor">#</a> 前缀索引</h3> <ul><li>语法：<code>create index idx_xxxx on table_name(column(n))</code></li> <li>前缀长度：可以根据索引的选择性来决定，选择先是指不重复的索引值（基数）和数据表的记录总数的笔直，索引选择性越高则查询效率越高，唯一索引的选择性是1，这是最好的索引选择性，性能也是最好的</li></ul> <div class="language-mysql extra-class"><pre class="language-text"><code>select count(distinct email)/count(*) from tb_user;
select count(distinct substring(email,1,5))/count(*) from tb_user;
</code></pre></div><h2 id="索引设计原则"><a href="#索引设计原则" class="header-anchor">#</a> 索引设计原则</h2> <ol><li>针对于数据量较大，且查询比较频繁的表建立索引</li> <li>针对于常作为查询条件（where）、排序（order by）、分组（group by）操作的字段建立索引</li> <li>尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</li> <li>如果是字符串类型的字段，字段的长度较长，可以针对字段的特点，建立前缀索引</li> <li>尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免徽标，提高查询效率</li> <li>要控制索引的数量，索引越多，维护索引结构的代价越大，影响增删改的效率</li> <li>如果索引列不能存储null值，请在创建表的时候用not null约束。当优化器知道每列是否包含null值时，它可以更好地确定哪个索引最有效地用于查询</li></ol> <hr> <h2 id="sql优化"><a href="#sql优化" class="header-anchor">#</a> SQL优化</h2> <h3 id="插入数据"><a href="#插入数据" class="header-anchor">#</a> 插入数据</h3> <p>insert优化：</p> <ul><li>使用批量插入插入多条数据（500-1000条）如果数据太多，可以分为几次insert插入</li> <li>手动提交事务（减少事务的开启与关闭）</li> <li>主键顺序插入（见主键优化）：主键插入性能高于乱序插入</li> <li>如果一次性需要插入<strong>大批量数据</strong>，可以使用MySQL提供的load指令进行插入</li> <li>步骤</li></ul> <div class="language-mysql extra-class"><pre class="language-text"><code># 客户端连接服务器时，加上参数 --local-infile
mysql --local-infile -u root -p
#查看全局参数local_infile
select @@local_infile;
# 设置全局参数local_infile为1，开启从本地加载文件导入数据的开关
set global local_infile = 1;
# 执行local指令将准备好的数据加载到表结构当中
load data local infile '/root/sql1.log' into table 'tb_user' fields terminated by ',' lines terminated by '\n';
</code></pre></div><h3 id="主键优化"><a href="#主键优化" class="header-anchor">#</a> 主键优化</h3> <p>数据组织方式：再InnoDB存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称之为索引组织表</p> <p>页分裂：</p> <p>页可以为空，也可以填充一般，也可以填充100%。每个页包含了2-N行数据，根据主键排列。主键乱序插入的情况下容易产生页分裂</p> <p>页合并：</p> <p>当删除一行记录时，实际上记录并没有被物理删除，只是被标记为删除并且它的空间变得允许被其他记录声明使用，当页中删除的记录达到merge_threshold（默认为页的50%），InnoDB会开始寻址最靠近的页（前或后）看看是否可以将两个页合并以优化空间使用。</p> <p>==注==：merge_threshold为合并页的阈值，可以自己设置，再创建表或者创建索引时指定</p> <p><strong>主键设计原则</strong>：</p> <ul><li>在满足业务的需求下，尽量降低主键的长度</li> <li>插入数据时，尽量选择顺序插入，选择使用auto_increment自增主键</li> <li>尽量不要使用UUID或是其他自然主键做主键，如身份证号</li> <li>业务操作时，尽量避免对主键的修改</li></ul> <h3 id="order-by优化"><a href="#order-by优化" class="header-anchor">#</a> order by优化</h3> <ol><li>using filesort：通过表的索引或全表扫描，读取满足条件的数据行，然后再排序缓冲区sort buffer中完成排序操作，所有不是通过索引直接返回排序结构的排序都叫filesort排序</li> <li>using index：通过 有序索引顺序扫描直接返回有序数据，不需要额外排序，操作效率高</li></ol> <div class="language-mysql extra-class"><pre class="language-text"><code># 没有创建索引时，根据age,phone排序
explain select id,age,phone from tb_user order by age,phone;
# 创建索引
create index idx_user_age_phone_aa on tb_user(age,phone)
#创建索引后，根据age,phone进行升序排序
explain select id,age,phone from tb_user order by age,phone;
#创建索引后，根据age,phone进行降序排序
explain select id,age,phone from tb_user order by age desc,phone desc;
</code></pre></div><ul><li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则</li> <li>尽量使用覆盖索引</li> <li>多字段排序，一个升序一个降序，此时需要注意联合索引再创建时的规则（ASC/DESC）</li> <li>如果不可避免地出现filesort，大数据量排序时，可以适当增大排序缓冲区大小sort_buffer_seize（默认256k）</li></ul> <h3 id="group-by优化"><a href="#group-by优化" class="header-anchor">#</a> group by优化</h3> <ul><li>在分组操作时，可以通过索引来提高效率</li> <li>在分组操作时，索引的使用也是满足最左前缀法则的</li></ul> <div class="language-mysql extra-class"><pre class="language-text"><code>create index idx_user_pro_age_sta on tb_user(profession,age,status);
#
explain select profession,count(*) from tb_user group by profession;
# 创建了临时表，效率较慢
explain select age,count(*) from tb_user group by age;
# 符合最左前缀法则，使用了索引，效率较快
explain select age,count(*) from tb_user group by profession , age;
# where条件也能满足最左前缀法则
explain select age,count(*) from tb_user where profession = '软件工程' group by age;
</code></pre></div><h3 id="limit优化"><a href="#limit优化" class="header-anchor">#</a> limit优化</h3> <p>limit在大数据量的情况下，越往后耗时越长</p> <p>采用覆盖索引+子查询的方式解决</p> <div class="language-mysql extra-class"><pre class="language-text"><code>select * from tb_sku s, (select id from tb_sku order by id limit 9000000,10) a where s.id = a.id;
</code></pre></div><h3 id="count优化"><a href="#count优化" class="header-anchor">#</a> count优化</h3> <ul><li>MyISAM引擎把一个表的总行数存在磁盘上，因此执行count(*)的时候会直接返回这个数，效率很高</li> <li>InnoDB在执行count(*)的时候，需要把数据一行一行地读出来，然后累积计数，优化思路：自己维护一个数存放count(x)</li> <li>count(主键)：InnoDB引擎会遍历整张表，把每一行的主键id值都取出来，返回给服务层，服务层拿到主键后，直接按行进行累加（主键不可能为null）</li> <li>count(字段)：InnoDB会遍历整张表，把每一行的字段值都取出来，返回给服务层。如果有not null约束，直接累加，如果没有，则服务层会先判断再累加</li> <li>count(1)：InnoDB引擎遍历整张表，但是<strong>不取值</strong>，对于返回的每一行，服务层直接累加</li> <li>count(*)：InnoDB引擎专门做了优化，<strong>不取值</strong>直接累加</li> <li>按效率排序，count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)，所以尽量使用count(星)</li></ul> <h3 id="update优化"><a href="#update优化" class="header-anchor">#</a> update优化</h3> <p>InnoDB的行锁是针对索引加的锁，不是针对记录加的锁，并且该索引不能失效，否则会从行锁升级成表锁</p> <p>注意事项：在更新时要根据索引字段进行更新，避免行锁升级成表锁</p></div></div></div> <!----></div> <div class="right"><div class="test animated bounceInRight" data-v-1daa5799><span class="labeltitle" data-v-1daa5799>分类</span> <div class="label-container" data-v-1daa5799><a href="/my-blogs/category" class="container" data-v-3fd29ed0 data-v-1daa5799>
  All
</a><a href="/my-blogs/category/blender" class="container" data-v-3fd29ed0 data-v-1daa5799>
  blender
</a><a href="/my-blogs/category/Java" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Java
</a><a href="/my-blogs/category/Mysql" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Mysql
</a><a href="/my-blogs/category/spring" class="container" data-v-3fd29ed0 data-v-1daa5799>
  spring
</a><a href="/my-blogs/category/Rust" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Rust
</a><a href="/my-blogs/category/java" class="container" data-v-3fd29ed0 data-v-1daa5799>
  java
</a><a href="/my-blogs/category/计算机网络" class="container" data-v-3fd29ed0 data-v-1daa5799>
  计算机网络
</a><a href="/my-blogs/category/Java多线程" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Java多线程
</a><a href="/my-blogs/category/C#" class="container" data-v-3fd29ed0 data-v-1daa5799>
  C#
</a><a href="/my-blogs/category/Python" class="container" data-v-3fd29ed0 data-v-1daa5799>
  Python
</a><a href="/my-blogs/category/C++" class="container" data-v-3fd29ed0 data-v-1daa5799>
  C++
</a><a href="/my-blogs/category/计算机图形学" class="container" data-v-3fd29ed0 data-v-1daa5799>
  计算机图形学
</a><a href="/my-blogs/category/数学基础" class="container" data-v-3fd29ed0 data-v-1daa5799>
  数学基础
</a></div></div> <div class="my" data-v-85113e2e><div class="header-info" data-v-85113e2e><div class="avatar" data-v-85113e2e><img src="https://lunatics.oss-cn-hangzhou.aliyuncs.com/icon.jpg" alt class="avatar-img" data-v-85113e2e></div> <span class="name" data-v-85113e2e>CheesyCrab</span> <i class="mail" data-v-85113e2e>1592913644@qq.com</i> <div class="statistics" data-v-85113e2e><span class="articles" data-v-85113e2e>
        26
        <i class="white" data-v-85113e2e> 文章</i></span> <span class="verticle-line white" data-v-85113e2e>|</span> <span class="link" data-v-85113e2e>
        13
        <i class="white" data-v-85113e2e> 分类</i></span></div> <a href="/my-blogs/contact" class="more" data-v-85113e2e>联系我</a></div></div> <div class="list"><div><ul><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#索引概述">索引概述</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#索引结构">索引结构</a><ul><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#b-tree-多路平衡查找树">B-Tree（多路平衡查找树）</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#hash索引">Hash索引</a></li></ul></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#索引语法">索引语法</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#sql性能分析">SQL性能分析</a><ul><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#慢查询日志">慢查询日志</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#profile详情">profile详情</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#explain执行计划">==explain执行计划==</a></li></ul></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#索引使用">索引使用</a><ul><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#sql提示">SQL提示</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#覆盖索引">覆盖索引</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#前缀索引">前缀索引</a></li></ul></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#索引设计原则">索引设计原则</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#sql优化">SQL优化</a><ul><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#插入数据">插入数据</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#主键优化">主键优化</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#order-by优化">order by优化</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#group-by优化">group by优化</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#limit优化">limit优化</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#count优化">count优化</a></li><li><a href="/my-blogs/2022/09/21/no13%E7%B4%A2%E5%BC%95/#update优化">update优化</a></li></ul></li></ul></div></div></div></div> <div class="footer"><div class="left"><div class="wave-libra"><div class="wavetext"><div class="coast delay"><div class="wave-rel-wrap"><div class="wave delay"></div></div></div> <div class="text text-l">L</div> <div class="text text-i">i</div> <div class="text text-b">b</div> <div class="text text-r">r</div> <div class="text text-a">a</div></div></div></div> <div class="right">
    Copyright © 2019-2020 Libra | 版权所有
  </div></div></div><div class="global-ui"><!----></div></div>
    <script src="/my-blogs/assets/js/app.5c4894fb.js" defer></script><script src="/my-blogs/assets/js/4.606f7210.js" defer></script><script src="/my-blogs/assets/js/20.6d62cff2.js" defer></script>
  </body>
</html>
